import{r as c,u as N,o as O,w as V,c as u,a as o,b as v,F as S,d as j,e as I,f as k,g as h,v as f,h as P,n as U,i as d,j as H}from"./index-B0xkj7KZ.js";const J={class:"chat-section"},$={class:"chat-wrapper"},z={class:"message-content"},E={key:0,class:"user-label"},L={key:1,class:"ai-label"},F=["innerHTML"],K=["onClick"],q={key:0,class:"chat-message ai"},R=["disabled","onKeydown"],W=["disabled"],G=["disabled"],Q={class:"popup"},Z={__name:"NeiroView",setup(X){const l=c(""),s=c([]),i=c(!1),y=c(null),m=N();O(()=>{const a=localStorage.getItem("neiro_chat_history");a&&(s.value=JSON.parse(a))}),V(s,a=>{localStorage.setItem("neiro_chat_history",JSON.stringify(a))},{deep:!0});function p(){U(()=>{y.value&&(y.value.scrollTop=y.value.scrollHeight)})}async function _(){if(!l.value.trim())return;const a={role:"user",text:l.value};s.value.push(a);const t=l.value;l.value="",i.value=!0,p();try{const e=await fetch("https://tourgid-production.up.railway.app/api/ask",{method:"POST",headers:{Authorization:`Bearer ${m.token}`,"Content-Type":"application/json"},body:JSON.stringify({question:t})});if(!e.ok)throw new Error("Ошибка API");const n=await e.json();await T(n.answer)}catch(e){console.error(e),s.value.push({role:"ai",text:"Ошибка получения ответа."})}finally{i.value=!1,p()}}async function C(){if(!l.value.trim())return;const a={role:"user",text:l.value};s.value.push(a);const t=l.value;l.value="",i.value=!0,p();try{const e=await fetch("https://tourgid-production.up.railway.app/api/generate_route",{method:"POST",headers:{Authorization:`Bearer ${m.token}`,"Content-Type":"application/json"},body:JSON.stringify({query:t})});if(!e.ok)throw new Error("Ошибка API");const n=await e.json();console.log(n),typeof n.description=="string"&&n.description.length>0?await T(n.description,n.points):s.value.push({role:"ai",text:"Нет данных о маршруте."})}catch(e){console.error(e),s.value.push({role:"ai",text:"Ошибка получения маршрута."})}finally{i.value=!1,p()}}async function T(a,t=null){if(typeof a!="string"||!a.length)return;let e="";for(let n=0;n<a.length;n++)e+=a[n],n===0&&s.value.push({role:"ai",text:"",points:t}),s.value[s.value.length-1].text=e,await new Promise(x=>setTimeout(x,18+Math.random()*30)),p()}function M(a){let t=a.replace(/\*\*(.+?)\*\*/g,"<b>$1</b>");return t=t.replace(/\n/g,"<br>"),t}const w=c(!1),r=c({destination:"",startDate:"",endDate:"",notes:"",points:[]});let b=null;function A(a){w.value=!0,r.value={destination:"",startDate:"",endDate:"",notes:"",points:a.points||[]},b=s.value.indexOf(a)}function g(){w.value=!1,b=null}async function B(){try{if(!(await fetch("https://tourgid-production.up.railway.app/profile/trips",{method:"POST",headers:{Authorization:`Bearer ${m.token}`,"Content-Type":"application/json"},body:JSON.stringify(r.value)})).ok)throw new Error("Ошибка добавления маршрута");b!==null&&(s.value[b].added=!0),g(),alert("Маршрут успешно добавлен в профиль!")}catch(a){alert("Ошибка при добавлении маршрута"),console.error(a)}}function D(){s.value=[],localStorage.removeItem("neiro_chat_history")}return(a,t)=>(d(),u(S,null,[o("section",J,[o("div",$,[t[6]||(t[6]=o("div",{class:"chat-header"},[o("h2",null,"Чат с нейросетью")],-1)),o("div",{class:"chat-history",ref_key:"chatHistory",ref:y},[(d(!0),u(S,null,j(s.value,(e,n)=>(d(),u("div",{key:n,class:H(["chat-message",e.role])},[o("div",z,[e.role==="user"?(d(),u("span",E,"Вы:")):v("",!0),e.role==="ai"?(d(),u("span",L,"Нейросеть:")):v("",!0),o("span",{innerHTML:M(e.text)},null,8,F),e.role==="ai"&&e.points&&!e.added?(d(),u("button",{key:2,class:"add-trip-btn",onClick:x=>A(e)}," Добавить маршрут ",8,K)):v("",!0)])],2))),128)),i.value?(d(),u("div",q,t[5]||(t[5]=[I('<div class="message-content"><span class="ai-label">Нейросеть:</span><span class="typing-indicator"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>',1)]))):v("",!0)],512),o("form",{class:"chat-input",onSubmit:k(_,["prevent"])},[h(o("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>l.value=e),type:"text",placeholder:"Введите сообщение...",disabled:i.value,onKeydown:P(k(_,["exact","prevent"]),["enter"])},null,40,R),[[f,l.value]]),o("button",{disabled:!l.value.trim()||i.value},"Отправить",8,W),o("button",{type:"button",class:"route-btn",disabled:!l.value.trim()||i.value,onClick:C}," Сформировать маршрут ",8,G)],32),o("div",{class:"clear-btn__wrapper"},[o("button",{class:"clear-chat-btn",onClick:D},"Очистить чат")])])]),w.value?(d(),u("div",{key:0,class:"popup-backdrop",onClick:k(g,["self"])},[o("div",Q,[t[7]||(t[7]=o("h3",null,"Добавить маршрут",-1)),h(o("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>r.value.destination=e),placeholder:"Название маршрута (например, Южный берег Крыма)"},null,512),[[f,r.value.destination]]),h(o("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>r.value.startDate=e),type:"date",placeholder:"Дата начала"},null,512),[[f,r.value.startDate]]),h(o("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>r.value.endDate=e),type:"date",placeholder:"Дата окончания"},null,512),[[f,r.value.endDate]]),h(o("textarea",{"onUpdate:modelValue":t[4]||(t[4]=e=>r.value.notes=e),placeholder:"Заметки"},null,512),[[f,r.value.notes]]),o("button",{onClick:B,class:"upload-btn"},"Сохранить"),o("button",{onClick:g,class:"cancel-btn"},"Отмена")])])):v("",!0)],64))}};export{Z as default};
