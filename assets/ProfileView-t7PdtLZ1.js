import{u as I,r as S,l as H,w as Y,m as J,o as q,c as d,b as k,d as G,p as t,a as e,t as g,q as W,s as F,F as L,e as O,h as P,v as A,x as X,g as Z,j as c,k as K}from"./index-BtL-7-Lf.js";import{u as j,N as Q}from"./NotificationContainer-BB5IIq4R.js";const ee="https://tourgid-production.up.railway.app",z={POST:"POST",PUT:"PUT",DELETE:"DELETE"},oe={JSON:"application/json"},$=5*1024*1024,x=async(a,l={})=>{var p;const{token:u,...s}=l;if(s.body&&(s.body instanceof FormData?((p=s.body.get("photo"))==null?void 0:p.size)||0:JSON.stringify(s.body).length)>$)throw new Error(`Размер данных превышает максимально допустимый (${$/1024/1024}MB)`);const m=await fetch(`${ee}${a}`,{...s,headers:{...s.headers,...u&&{Authorization:`Bearer ${u}`}}});if(!m.ok){const r=await m.text();throw new Error(`Ошибка запроса: ${m.status} - ${r}`)}return m.json()},U={async getProfile(a){return x("/profile",{token:a})},async updateProfile(a,l){console.log("profileService: Начало обновления профиля");const u={username:l.username,email:l.email,name:l.name,surname:l.surname,phone:l.phone,gender:l.gender,birthday:l.birthday};console.log("profileService: Подготовленные данные:",u);const s=await x("/profile",{method:z.PUT,headers:{"Content-Type":oe.JSON},body:JSON.stringify(u),token:a});return console.log("profileService: Получен ответ от сервера:",s),s},async uploadPhoto(a,l){if(l.size>$)throw new Error(`Размер файла превышает максимально допустимый (${$/1024/1024}MB)`);const u=new FormData;return u.append("photo",l),x("/profile/upload-photo",{method:z.POST,body:u,token:a})},async getPhoto(a){return x("/profile/photo",{token:a})},async deleteTrip(a,l){return x(`/profile/trips/${l}`,{method:z.DELETE,token:a})}};function te(){const a=J(),l=I(),u=S(!1),s=S({username:"",email:"",name:"",surname:"",phone:"",gender:"",birthday:"",photo:null}),m=S("/tour-guide/img/user-default.jpg"),p=S(!1),r=S("profile"),y=[{id:"profile",label:"Информация о профиле"},{id:"history",label:"Мои туры"},{id:"security",label:"Изменение профиля"}],h=H(()=>{const i=y.find(v=>v.id===r.value);return i?i.label:""}),f=async()=>{if(!l.isAuth){a.push("/");return}u.value=!1;try{await l.fetchProfile(),l.user&&(s.value={...l.user})}catch(i){console.error("Ошибка загрузки профиля:",i)}finally{u.value=!0}},M=async()=>{console.log("useProfile: Начало сохранения профиля");try{console.log("useProfile: Отправляю данные на сервер:",s.value);const i=await U.updateProfile(l.token,s.value);return console.log("useProfile: Получен ответ от сервера:",i),l.user=i,console.log("useProfile: Профиль успешно обновлен"),{success:!0}}catch(i){return console.error("useProfile: Ошибка при сохранении профиля:",i),{success:!1,error:i}}},V=()=>{l.logout(),a.push("/")},N=()=>{p.value=!0},E=()=>{p.value=!1},T=S(""),D=async i=>{const v=i.target.files[0];if(T.value=v?v.name:"",!!v)try{const w=await U.uploadPhoto(l.token,v);return s.value={...s.value,photo:w.photoFilename,photoContentType:w.photoContentType,photoSize:w.photoSize,updatedAt:w.updatedAt},E(),{success:!0}}catch(w){return console.error("Ошибка загрузки фото:",w),{success:!1,message:"Ошибка загрузки фото"}}};return Y(()=>s.value.photo,async()=>{if(!s.value.photo){m.value="/tour-guide/img/user-default.jpg";return}try{const i=await U.getPhoto(l.token),v=atob(i.data),w=new Array(v.length);for(let _=0;_<v.length;_++)w[_]=v.charCodeAt(_);const b=new Uint8Array(w),o=new Blob([b],{type:i.contentType});m.value=URL.createObjectURL(o)}catch(i){console.error("Ошибка загрузки фото:",i),m.value="/tour-guide/img/user-default.jpg"}},{immediate:!0}),{isLoading:u,userData:s,avatarUrl:m,showAvatarPopup:p,activeTab:r,tabs:y,currentTabLabel:h,userStore:l,loadProfile:f,saveProfile:M,handleLogout:V,openModal:N,closeModal:E,onFileChange:D}}function se(){const a=[44.943376,34.098043],{showNotification:l}=j(),u=p=>new Promise((r,y)=>{if(!navigator.geolocation){l("Геолокация не поддерживается браузером","warning"),y(new Error("Геолокация не поддерживается браузером"));return}navigator.geolocation.getCurrentPosition(h=>{r([h.coords.latitude,h.coords.longitude])},h=>{let f;switch(h.code){case h.PERMISSION_DENIED:f="Доступ к геолокации запрещен пользователем";break;case h.POSITION_UNAVAILABLE:f="Информация о местоположении недоступна";break;case h.TIMEOUT:f="Время ожидания получения координат истекло";break;default:f="Неизвестная ошибка геолокации"}l(f,"warning"),y(new Error(f))},p)}),s=(p,r)=>{const y=`${p[1]},${p[0]}`,h=`${p[0]},${p[1]}~`+r.map(f=>`${f.coords[0]},${f.coords[1]}`).join("~");return`https://yandex.ru/maps/146/simferopol/?ll=${y}&mode=routes&rtext=${h}&rtt=mt&ruri=~~&z=13.6`};return{getUserCoords:u,getYandexRouteLink:s,openYandexRoute:async p=>{let r=a;try{r=await u({enableHighAccuracy:!0,timeout:5e3,maximumAge:0}),console.log("✅ Получены координаты пользователя:",r)}catch(h){l(`Ошибка: ${h.message}. Будет использован центр Симферополя.`,"warning"),console.log("🔄 Используются координаты по умолчанию (Симферополь):",r)}const y=s(r,p.points);window.open(y,"_blank")}}}function ne(){const a=I(),{openYandexRoute:l}=se();return{openYandexRoute:l,deleteTrip:async s=>{try{return await U.deleteTrip(a.token,s),await a.fetchProfile(),{success:!0}}catch(m){return console.error("Ошибка при удалении тура:",m),{success:!1,message:m.message}}}}}const le={key:0,class:"profile"},re={class:"profile-header"},ae={class:"profile-breadcrumbs"},ie={class:"profile-wrapper"},ue={class:"profile-card"},de={class:"profile-sidebar"},ce={class:"sidebar-content"},pe={class:"avatar-block"},fe=["src"],me={class:"user-name"},he={class:"user-username"},be={class:"user-meta"},ge={key:0,class:"user-birth"},ve={class:"profile-nav"},ye=["onClick"],we={key:0,class:"profile-content"},_e={class:"form-group"},ke=["disabled"],Pe={class:"form-group"},Te=["disabled"],Se={class:"form-group"},Ae=["disabled"],Ee={class:"form-group"},Ce=["disabled"],xe={class:"form-group"},Ne=["disabled"],De={class:"form-group"},Le=["disabled"],Ue={class:"form-group"},$e=["disabled"],Me={key:1,class:"profile-content"},Ve={key:0,class:"trips-list"},Oe={class:"trip-wrapper"},ze={class:"trip-dates"},Re={class:"trip-points"},Be={key:0,class:"trip-notes"},Fe={class:"trip-buttons"},Ie=["onClick"],je=["onClick"],He={key:1,class:"no-trips"},Ye={key:1,class:"profile loading"},Je={class:"popup"},qe={class:"file-input-wrapper"},Ge={class:"file-input-label"},We={key:0,class:"file-name"},Xe={class:"popup-actions"},Qe={__name:"ProfileView",props:{showAuth:{type:Boolean,required:!0}},emits:["openAuth","closeAuth"],setup(a){const{showNotification:l}=j(),{isLoading:u,userData:s,avatarUrl:m,showAvatarPopup:p,activeTab:r,tabs:y,currentTabLabel:h,userStore:f,loadProfile:M,saveProfile:V,handleLogout:N,openModal:E,closeModal:T,onFileChange:D}=te(),{openYandexRoute:R,deleteTrip:i}=ne(),v=async b=>{if(console.log("Данные тура:",b),!b.number){console.error("У тура отсутствует номер");return}const o=await i(b.number);o.success||console.error("Ошибка при удалении тура:",o.message)};async function w(){console.log("Начало сохранения профиля");try{const b=await V();console.log("Результат сохранения:",b),b.success?(console.log("Показываю уведомление об успехе"),l("Профиль успешно обновлен!","success")):(console.log("Показываю уведомление об ошибке"),l("Ошибка при обновлении профиля","error"))}catch(b){console.error("Ошибка при сохранении:",b),l("Произошла ошибка при сохранении профиля","error")}}return q(M),(b,o)=>{var _,B;return c(),d(L,null,[t(u)&&t(f).isAuth?(c(),d("section",le,[e("div",re,[o[12]||(o[12]=e("h1",null,"Мой профиль",-1)),e("div",ae,"Профиль / "+g(t(h)),1)]),e("div",ie,[e("div",ue,[e("aside",de,[e("div",ce,[e("div",null,[e("div",pe,[e("img",{class:"avatar",src:t(m),alt:"avatar",onClick:o[0]||(o[0]=(...n)=>t(E)&&t(E)(...n)),style:W({"--auth-token":t(f).token})},null,12,fe),e("div",me,g(t(s).name)+" "+g(t(s).surname),1),e("div",he,g(t(s).username),1),e("div",be,[t(s).birthDate?(c(),d("span",ge,[o[13]||(o[13]=e("i",{class:"icon-calendar"},null,-1)),F(" "+g(t(s).birthDate),1)])):k("",!0)])]),e("nav",ve,[(c(!0),d(L,null,O(t(y),n=>(c(),d("button",{key:n.id,class:K(["nav-btn",{active:t(r)===n.id}]),onClick:C=>r.value=n.id},g(n.label),11,ye))),128))])]),e("button",{class:"logout-btn",onClick:o[1]||(o[1]=(...n)=>t(N)&&t(N)(...n))},"Выйти")])]),t(r)==="profile"||t(r)==="security"?(c(),d("div",we,[e("h2",null,g(t(r)==="profile"?"Персональная информация":"Изменение профиля"),1),e("div",_e,[o[14]||(o[14]=e("label",null,"Имя пользователя:",-1)),P(e("input",{"onUpdate:modelValue":o[2]||(o[2]=n=>t(s).username=n),type:"text",disabled:t(r)==="profile"},null,8,ke),[[A,t(s).username]])]),e("div",Pe,[o[15]||(o[15]=e("label",null,"Почта:",-1)),P(e("input",{"onUpdate:modelValue":o[3]||(o[3]=n=>t(s).email=n),type:"text",disabled:t(r)==="profile"},null,8,Te),[[A,t(s).email]])]),e("div",Se,[o[16]||(o[16]=e("label",null,"Имя:",-1)),P(e("input",{"onUpdate:modelValue":o[4]||(o[4]=n=>t(s).name=n),type:"text",disabled:t(r)==="profile"},null,8,Ae),[[A,t(s).name]])]),e("div",Ee,[o[17]||(o[17]=e("label",null,"Фамилия:",-1)),P(e("input",{"onUpdate:modelValue":o[5]||(o[5]=n=>t(s).surname=n),type:"text",disabled:t(r)==="profile"},null,8,Ce),[[A,t(s).surname]])]),e("div",xe,[o[18]||(o[18]=e("label",null,"Номер телефона:",-1)),P(e("input",{"onUpdate:modelValue":o[6]||(o[6]=n=>t(s).phone=n),type:"text",disabled:t(r)==="profile"},null,8,Ne),[[A,t(s).phone]])]),e("div",De,[o[20]||(o[20]=e("label",{for:"gender-select"},"Пол:",-1)),P(e("select",{id:"gender-select","onUpdate:modelValue":o[7]||(o[7]=n=>t(s).gender=n),disabled:t(r)==="profile"},o[19]||(o[19]=[e("option",{value:""},"Выберите пол",-1),e("option",{value:"male"},"Мужчина",-1),e("option",{value:"female"},"Женщина",-1)]),8,Le),[[X,t(s).gender]])]),e("div",Ue,[o[21]||(o[21]=e("label",null,"Дата рождения:",-1)),P(e("input",{"onUpdate:modelValue":o[8]||(o[8]=n=>t(s).birthday=n),type:"date",disabled:t(r)==="profile"},null,8,$e),[[A,t(s).birthday]])]),t(r)==="security"?(c(),d("button",{key:0,class:"save-btn",onClick:w}," Сохранить ")):k("",!0)])):k("",!0),t(r)==="history"?(c(),d("div",Me,[o[25]||(o[25]=e("h2",null,"Мои туры",-1)),(B=(_=t(f).user)==null?void 0:_.myTrips)!=null&&B.length?(c(),d("div",Ve,[(c(!0),d(L,null,O(t(f).user.myTrips,n=>(c(),d("div",{key:n.startDate+n.destination,class:"trip-card"},[e("div",Oe,[e("h3",null,g(n.destination),1),e("div",ze,[e("span",null,"С "+g(new Date(n.startDate).toLocaleDateString()),1),e("span",null,"по "+g(new Date(n.endDate).toLocaleDateString()),1)]),e("div",Re,[o[22]||(o[22]=e("b",null,"Точки маршрута:",-1)),e("ul",null,[(c(!0),d(L,null,O(n.points,C=>(c(),d("li",{key:C.name},g(C.name),1))),128))])]),n.notes?(c(),d("div",Be,[o[23]||(o[23]=e("b",null,"Заметки:",-1)),F(" "+g(n.notes),1)])):k("",!0)]),e("div",Fe,[e("button",{class:"build-route-btn",onClick:C=>t(R)(n)}," Построить маршрут ",8,Ie),e("button",{class:"delete-trip-btn",onClick:C=>v(n)},o[24]||(o[24]=[e("span",null,[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"200",height:"200",viewBox:"0 0 20 20",fill:"#000000"},[e("path",{fill:"#000000",d:"m6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"})])],-1)]),8,je)])]))),128))])):(c(),d("div",He,"У вас пока нет сохранённых туров"))])):k("",!0)])])])):(c(),d("div",Ye,"Загрузка профиля...")),t(p)?(c(),d("div",{key:2,class:"popup-backdrop",onClick:o[11]||(o[11]=Z((...n)=>t(T)&&t(T)(...n),["self"]))},[e("div",Je,[o[27]||(o[27]=e("h3",null,"Загрузить новое фото",-1)),e("div",qe,[e("label",Ge,[o[26]||(o[26]=e("span",null,"Выбрать файл",-1)),e("input",{type:"file",accept:"image/*",onChange:o[9]||(o[9]=(...n)=>t(D)&&t(D)(...n)),ref:"fileInput"},null,544)]),b.selectedFileName?(c(),d("span",We,g(b.selectedFileName),1)):k("",!0)]),e("div",Xe,[e("button",{class:"cancel-btn",onClick:o[10]||(o[10]=(...n)=>t(T)&&t(T)(...n))},"Отмена")])])])):k("",!0),G(Q)],64)}}};export{Qe as default};
