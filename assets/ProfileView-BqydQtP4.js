import{u as B,r as w,k as R,w as H,l as J,o as Y,c as u,b as y,m as s,a as t,t as f,p as I,q as j,F as L,d as N,g,v as k,s as q,e as W,x as X,y as Z,f as G,i as p,j as K}from"./index-BuKrKZep.js";const Q="https://tourgid-production.up.railway.app",O={POST:"POST",PUT:"PUT",DELETE:"DELETE"},ee={JSON:"application/json"},V=1024*1024,P=async(i,l={})=>{var a;const{token:n,...r}=l;if(r.body&&(r.body instanceof FormData?((a=r.body.get("photo"))==null?void 0:a.size)||0:JSON.stringify(r.body).length)>V)throw new Error(`Размер данных превышает максимально допустимый (${V/1024/1024}MB)`);const m=await fetch(`${Q}${i}`,{...r,headers:{...r.headers,...n&&{Authorization:`Bearer ${n}`}}});if(!m.ok){const b=await m.text();throw new Error(`Ошибка запроса: ${m.status} - ${b}`)}return m.json()},U={async getProfile(i){return P("/profile",{token:i})},async updateProfile(i,l){const n={username:l.username,email:l.email,name:l.name,surname:l.surname,phone:l.phone,gender:l.gender,birthday:l.birthday};return P("/profile",{method:O.PUT,headers:{"Content-Type":ee.JSON},body:JSON.stringify(n),token:i})},async uploadPhoto(i,l){if(l.size>V)throw new Error(`Размер файла превышает максимально допустимый (${V/1024/1024}MB)`);const n=new FormData;return n.append("photo",l),P("/profile/upload-photo",{method:O.POST,body:n,token:i})},async getPhoto(i){return P("/profile/photo",{token:i})},async deleteTrip(i,l){return P(`/profile/trips/${l}`,{method:O.DELETE,token:i})}};function te(){const i=J(),l=B(),n=w(!1),r=w({username:"",email:"",name:"",surname:"",phone:"",gender:"",birthday:"",photo:null}),m=w("/tour-guide/img/user-default.jpg"),a=w(!1),b=w("profile"),S=[{id:"profile",label:"Информация о профиле"},{id:"history",label:"Мои туры"},{id:"security",label:"Изменение профиля"}],_=R(()=>{const d=S.find(c=>c.id===b.value);return d?d.label:""}),$=async()=>{if(!l.isAuth){i.push("/");return}n.value=!1;try{await l.fetchProfile(),l.user&&(r.value={...l.user})}catch(d){console.error("Ошибка загрузки профиля:",d)}finally{n.value=!0}},C=async()=>{try{const d=await U.updateProfile(l.token,r.value);return l.user=d,{success:!0,message:"Профиль успешно сохранён!"}}catch(d){return console.error("Ошибка при сохранении профиля:",d),{success:!1,message:d.message||"Ошибка при сохранении профиля"}}},D=()=>{l.logout(),i.push("/")},x=()=>{a.value=!0},h=()=>{a.value=!1},A=w(""),z=async d=>{const c=d.target.files[0];if(A.value=c?c.name:"",!!c)try{const e=await U.uploadPhoto(l.token,c);return r.value={...r.value,photo:e.photoFilename,photoContentType:e.photoContentType,photoSize:e.photoSize,updatedAt:e.updatedAt},h(),{success:!0}}catch(e){return console.error("Ошибка загрузки фото:",e),{success:!1,message:"Ошибка загрузки фото"}}};return H(()=>r.value.photo,async()=>{if(!r.value.photo){m.value="/tour-guide/img/user-default.jpg";return}try{const d=await U.getPhoto(l.token),c=atob(d.data),e=new Array(c.length);for(let v=0;v<c.length;v++)e[v]=c.charCodeAt(v);const M=new Uint8Array(e),E=new Blob([M],{type:d.contentType});m.value=URL.createObjectURL(E)}catch(d){console.error("Ошибка загрузки фото:",d),m.value="/tour-guide/img/user-default.jpg"}},{immediate:!0}),{isLoading:n,userData:r,avatarUrl:m,showAvatarPopup:a,activeTab:b,tabs:S,currentTabLabel:_,userStore:l,loadProfile:$,saveProfile:C,handleLogout:D,openModal:x,closeModal:h,onFileChange:z}}function se(){const i=B();return{openYandexRoute:r=>{const m=r.points.map(a=>`${a.lat},${a.lon}`).join("~");window.open(`https://yandex.ru/maps/?rtext=${m}&rtt=auto`,"_blank")},deleteTrip:async r=>{try{return await U.deleteTrip(i.token,r),await i.fetchProfile(),{success:!0}}catch(m){return console.error("Ошибка при удалении тура:",m),{success:!1,message:m.message}}}}}const oe={key:0,class:"profile"},ne={class:"profile-header"},le={class:"profile-breadcrumbs"},ae={class:"profile-wrapper"},re={class:"profile-card"},ie={class:"profile-sidebar"},de={class:"sidebar-content"},ue={class:"avatar-block"},pe=["src"],ce={class:"user-name"},me={class:"user-username"},fe={class:"user-meta"},be={key:0,class:"user-birth"},he={class:"profile-nav"},ve=["onClick"],ye={key:0,class:"profile-content"},ge={class:"form-group"},_e=["disabled"],we={class:"form-group"},ke=["disabled"],Te={class:"form-group"},Pe=["disabled"],Se={class:"form-group"},Ce=["disabled"],De={class:"form-group"},xe=["disabled"],Ae={class:"form-group"},Ee=["disabled"],Le={class:"form-group"},Ue=["disabled"],Ve={key:1,class:"profile-content"},$e={key:0,class:"trips-list"},ze={class:"trip-wrapper"},Me={class:"trip-dates"},Ne={class:"trip-points"},Oe={key:0,class:"trip-notes"},Fe={class:"trip-buttons"},je=["onClick"],Be=["onClick"],Re={key:1,class:"no-trips"},He={key:1,class:"profile loading"},Je={class:"popup"},Ye={class:"file-input-wrapper"},Ie={class:"file-input-label"},qe={key:0,class:"file-name"},We={class:"popup-actions"},Ze={__name:"ProfileView",setup(i){const{isLoading:l,userData:n,avatarUrl:r,showAvatarPopup:m,activeTab:a,tabs:b,currentTabLabel:S,userStore:_,loadProfile:$,saveProfile:C,handleLogout:D,openModal:x,closeModal:h,onFileChange:A}=te(),{openYandexRoute:z,deleteTrip:F}=se(),d=async c=>{if(console.log("Данные тура:",c),!c.number){console.error("У тура отсутствует номер");return}const e=await F(c.number);e.success||console.error("Ошибка при удалении тура:",e.message)};return Y($),(c,e)=>{var E,v;const M=Z("selectedcontent");return p(),u(L,null,[s(l)&&s(_).isAuth?(p(),u("section",oe,[t("div",ne,[e[13]||(e[13]=t("h1",null,"Мой профиль",-1)),t("div",le,"Профиль / "+f(s(S)),1)]),t("div",ae,[t("div",re,[t("aside",ie,[t("div",de,[t("div",null,[t("div",ue,[t("img",{class:"avatar",src:s(r),alt:"avatar",onClick:e[0]||(e[0]=(...o)=>s(x)&&s(x)(...o)),style:I({"--auth-token":s(_).token})},null,12,pe),t("div",ce,f(s(n).name)+" "+f(s(n).surname),1),t("div",me,f(s(n).username),1),t("div",fe,[s(n).birthDate?(p(),u("span",be,[e[14]||(e[14]=t("i",{class:"icon-calendar"},null,-1)),j(" "+f(s(n).birthDate),1)])):y("",!0)])]),t("nav",he,[(p(!0),u(L,null,N(s(b),o=>(p(),u("button",{key:o.id,class:K(["nav-btn",{active:s(a)===o.id}]),onClick:T=>a.value=o.id},f(o.label),11,ve))),128))])]),t("button",{class:"logout-btn",onClick:e[1]||(e[1]=(...o)=>s(D)&&s(D)(...o))},"Выйти")])]),s(a)==="profile"||s(a)==="security"?(p(),u("div",ye,[t("h2",null,f(s(a)==="profile"?"Персональная информация":"Изменение профиля"),1),t("div",ge,[e[15]||(e[15]=t("label",null,"Имя пользователя:",-1)),g(t("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>s(n).username=o),type:"text",disabled:s(a)==="profile"},null,8,_e),[[k,s(n).username]])]),t("div",we,[e[16]||(e[16]=t("label",null,"Почта:",-1)),g(t("input",{"onUpdate:modelValue":e[3]||(e[3]=o=>s(n).email=o),type:"text",disabled:s(a)==="profile"},null,8,ke),[[k,s(n).email]])]),t("div",Te,[e[17]||(e[17]=t("label",null,"Имя:",-1)),g(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>s(n).name=o),type:"text",disabled:s(a)==="profile"},null,8,Pe),[[k,s(n).name]])]),t("div",Se,[e[18]||(e[18]=t("label",null,"Фамилия:",-1)),g(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>s(n).surname=o),type:"text",disabled:s(a)==="profile"},null,8,Ce),[[k,s(n).surname]])]),t("div",De,[e[19]||(e[19]=t("label",null,"Номер телефона:",-1)),g(t("input",{"onUpdate:modelValue":e[6]||(e[6]=o=>s(n).phone=o),type:"text",disabled:s(a)==="profile"},null,8,xe),[[k,s(n).phone]])]),t("div",Ae,[e[21]||(e[21]=t("label",{for:"gender-select"},"Пол:",-1)),g(t("select",{id:"gender-select","onUpdate:modelValue":e[7]||(e[7]=o=>s(n).gender=o),disabled:s(a)==="profile"},[t("button",null,[X(M)]),e[20]||(e[20]=W('<option value="">Выберите пол</option><option value="male"><span class="option-label">Мужчина</span></option><option value="female"><span class="option-label">Женщина</span></option>',3))],8,Ee),[[q,s(n).gender]])]),t("div",Le,[e[22]||(e[22]=t("label",null,"Дата рождения:",-1)),g(t("input",{"onUpdate:modelValue":e[8]||(e[8]=o=>s(n).birthday=o),type:"date",disabled:s(a)==="profile"},null,8,Ue),[[k,s(n).birthday]])]),s(a)==="security"?(p(),u("button",{key:0,class:"save-btn",onClick:e[9]||(e[9]=(...o)=>s(C)&&s(C)(...o))}," Сохранить ")):y("",!0)])):y("",!0),s(a)==="history"?(p(),u("div",Ve,[e[26]||(e[26]=t("h2",null,"Мои туры",-1)),(v=(E=s(_).user)==null?void 0:E.myTrips)!=null&&v.length?(p(),u("div",$e,[(p(!0),u(L,null,N(s(_).user.myTrips,o=>(p(),u("div",{key:o.startDate+o.destination,class:"trip-card"},[t("div",ze,[t("h3",null,f(o.destination),1),t("div",Me,[t("span",null,"С "+f(new Date(o.startDate).toLocaleDateString()),1),t("span",null,"по "+f(new Date(o.endDate).toLocaleDateString()),1)]),t("div",Ne,[e[23]||(e[23]=t("b",null,"Точки маршрута:",-1)),t("ul",null,[(p(!0),u(L,null,N(o.points,T=>(p(),u("li",{key:T.name},f(T.name),1))),128))])]),o.notes?(p(),u("div",Oe,[e[24]||(e[24]=t("b",null,"Заметки:",-1)),j(" "+f(o.notes),1)])):y("",!0)]),t("div",Fe,[t("button",{class:"build-route-btn",onClick:T=>s(z)(o)}," Построить маршрут ",8,je),t("button",{class:"delete-trip-btn",onClick:T=>d(o)},e[25]||(e[25]=[t("span",null,[t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"200",height:"200",viewBox:"0 0 20 20",fill:"#000000"},[t("path",{fill:"#000000",d:"m6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"})])],-1)]),8,Be)])]))),128))])):(p(),u("div",Re,"У вас пока нет сохранённых туров"))])):y("",!0)])])])):(p(),u("div",He,"Загрузка профиля...")),s(m)?(p(),u("div",{key:2,class:"popup-backdrop",onClick:e[12]||(e[12]=G((...o)=>s(h)&&s(h)(...o),["self"]))},[t("div",Je,[e[28]||(e[28]=t("h3",null,"Загрузить новое фото",-1)),t("div",Ye,[t("label",Ie,[e[27]||(e[27]=t("span",null,"Выбрать файл",-1)),t("input",{type:"file",accept:"image/*",onChange:e[10]||(e[10]=(...o)=>s(A)&&s(A)(...o)),ref:"fileInput"},null,544)]),c.selectedFileName?(p(),u("span",qe,f(c.selectedFileName),1)):y("",!0)]),t("div",We,[t("button",{class:"cancel-btn",onClick:e[11]||(e[11]=(...o)=>s(h)&&s(h)(...o))},"Отмена")])])])):y("",!0)],64)}}};export{Ze as default};
